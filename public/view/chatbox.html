<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tick-Talk</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merienda&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" 
    integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd" crossorigin="anonymous">
    <link rel="stylesheet" href="./chatbox.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container d-flex">
        <a class="navbar-brand px-3 fs-2" style="font-family: 'Merienda'; font-weight: 600; color: cadetblue;" href="#">Tick-Talk</a>
        <div class="d-flex">
             <a href="/register.html"><button class="bttn mx-3">Logout</button></a>                                        
        </div>
        <div class="navbar-toggler fs-3 mx-3">
            <a style="color: #439395;" href="/public/view/register.html"><i class="fa-solid fa-right-from-bracket"></i></a>
        </div>           
      </div>
      </nav>

      <section>
      <div class="container-fluid">
        <div class="row fullbody">
          <div class="col-lg-4 contactbody mx-1">

            <div class="row border-4 border-bottom py-1">
              <div class="col-9 d-flex ">
                <!-- <img src="../img/komal gurudwara.jpeg" alt=""> -->
                <i class="bi-person-circle text-center fs-1 px-2"></i>
                <div id="userprofilename"></div>
                <p id="profilestatusupdate"></p>
              </div>
              <div class="col-3 d-flex align-items-center">
                <!-- <i class="bi bi-chat-right-text-fill fs-2"></i> -->
                <div class="container">
                  <div class="row">

                      <div class="dropdown">
                          <i class="bi bi-three-dots-vertical py-2 fs-3 " id="dropdownMenuButton1" data-toggle="dropdown" aria-expanded="false"></i>                
                          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                            <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo" href="#">New Group</a></li>
                            <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#statusModal" data-bs-whatever="@mdo" href="#">Status</a></li>                  
                            <li><a class="dropdown-item" href="register.html">Log out</a></li>
                          </ul>
                      </div> 

                      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Create a Group</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <form method="post" onsubmit="createGroup(event)">
                                  <div class="mb-3">
                                    <label for="proname" class="col-form-label">Add group participant</label>
                                    <input type="text" class="form-control" id="proname">
                                  </div>
                                  <div class="mb-3">
                                    <label for="proname" class="col-form-label">Add group name</label>
                                    <div class="dropdown">
                                      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                        Select Participant
                                      </button>                                                    
                                      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdownItemList">
                                        <!-- Dynamic items will be inserted here -->
                                      </ul>
                                    </div>
                                  </div>

                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Create</button>
                              </div>
                            </form>
                            </div>
                          </div>
                        </div>

                        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="exampleStatusModalLabel">Edit Status</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <form  onsubmit="status1(event)">
                                  <div class="mb-3">
                                    <label for="statusupdate" class="col-form-label">Add New Status</label>
                                    <input type="text" class="form-control" id="statusupdate">
                                  </div>                                          

                              </div>
                              <div class="modal-footer">
                                <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
                                <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Create</button>
                              </div>
                            </form>
                            </div>
                          </div>
                        </div>                         


                    </div>
                  </div>
              </div>
            </div>

            <div class="list-group">
              <!-- <div class="list-group-item d-flex align-items-center py-2">
                <div class="col-2 d-flex">
                <i class="bi-person-circle text-center fs-2"></i>
                </div>
                <div class="col-8 list ">
                <h5 style="margin: 0;">Name 1</h5>
                <i class="bi bi-circle-fill " style="color: green; font-size: 13px;"> Online</i> 
                </div>
              </div> -->
              <div class="list-group-item d-flex align-items-center py-2" id="friendlist">

              </div>
              
            </div>

          </div>

          <div class="col chatbody mx-1">
              <div class="row border-4 border-bottom py-1" style="height: 73px;">
                <div class="col-lg-1 d-flex">
                  <div class="d-flex justify-content-center" id="onlineuserimg">
                                  
                  </div>
                </div>
                <div class="col py-2 d-flex align-items-center">
                  <div class="py-2 d-flex align-items-center" id="onlineusername">                                                 
                  </div>                                
                </div> 
                <div class="col-3 d-flex align-items-center justify-content-between">
                  <i class="bi bi-telephone-forward-fill fs-4"></i>
                  <i class="bi bi-search fs-4"></i>
                  <i class="bi bi-three-dots-vertical fs-4"></i>
                </div>
              </div>
          
          <!-- message showing area -->
            <div class="row messagebox border-4 border-bottom py-2">
              <div class="col-12" >
                <ul id="messagebox">

                </ul>
              </div>
            </div>
          <!-- message typing area -->
            <div class="row writepad">
              <div class="col-12 py-1">
                <form method="post" onsubmit="chatData(event)">
                  <div class="row">
                    <div class="col-lg-9">
                      <input class="form-control" type="text" name="message" id="message">
                    </div>
                    <div class="col-lg-3">
                    <button class="button1" type="submit"><i class="bi-send fs-3" style="color: #0659ea;"></i></button>
                      <i class="bi bi-paperclip mx-1 fs-3"></i> 
                      <input type="file" id="chatFile" accept="image/*, video/*" />                                
                      <i class="bi bi-camera mx-1 fs-3" style="color: #0b5be5;"></i>
                      <i class="fa-regular fa-face-smile mx-2 fs-3" style="color: #3253f5;"></i>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <!-- message typing area -->
          </div>

        </div>
      </div>
      </section>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script> 
  <script>

    const socket= io.connect('http://localhost:3000');
    socket.on('receive-message', (messageData)=>{
      updateChatUI(messageData);
    });

    function sendMessage(messageData){
      socket.emit('new-message', messageData);
    }   
    
async function chatData(event){
    const selectedUserId= localStorage.getItem('selectedUserId');
    const token= localStorage.getItem('token');
    const decodedToken= parseJwt(token);
    const currentUserId= decodedToken.userId;
      event.preventDefault();

      const message= document.getElementById('message').value;
      const selectedGroupId= localStorage.getItem('selectedGroupId');

      const obj= { 
        message,
        groupId: selectedGroupId || null,
        userId: currentUserId,
        receipientId: selectedUserId
      }
      console.log('obj', obj);
      const fileInput= document.getElementById('chatFile');
      const file = fileInput.files[0];
      const formData = new FormData();

      formData.append('message', message);
      formData.append('file', file)

      try{
        const token= localStorage.getItem('token');
        const response=await axios.post('http://localhost:3000/chat', formData, {
          headers :{
            'Authorization': token,
            'Content-Type': 'multipart/form-data'
          }
          })
        console.log(response.data);
        sendMessage(obj)
        fetchandShowData(response.data);
      }catch(err){
        console.log(err)
      }

    }

  window.addEventListener('DOMContentLoaded', async()=>{
    //fetchandShowData();
    setInterval(showChats, 2000);
    localStorage.removeItem('selectedGroupId')
    localStorage.removeItem('selectedUserId')
  }
  ) 
  
  const max_msg= 5;
  async function fetchandShowData(){
    const selectedGroupId = localStorage.getItem('selectedGroupId');
    const selectedUserId = localStorage.getItem('selectedUserId');

    let url, dataKey;
    if (selectedGroupId) {
        url = `http://localhost:3000/chat/group/${selectedGroupId}`;
        dataKey = 'messages';
    } else if (selectedUserId) {
        url = `http://localhost:3000/chat/user/${selectedUserId}`;
        dataKey = 'messages'; 
    } else {
        url = 'http://localhost:3000/chat/user';
        dataKey = 'allChatData';
    }

    console.log("dataKey:", dataKey);

      try{
      const token=localStorage.getItem('token')           
      const response= await axios.get(url, { headers: {"Authorization" : token} }) 
        console.log('Api res', response);

      if(response.status === 200){
      const data=response.data[dataKey];
      console.log('data', data)

      const lastMessages = data.slice(-max_msg);
      localStorage.setItem('lastMessages', JSON.stringify(lastMessages));
      }else{
        throw new Error();
      }
      }catch(err){
    console.log(err)
      }
    }

  function showChats() {      
    let message= JSON.parse(localStorage.getItem('lastMessages'));
    const token = localStorage.getItem('token');
    const decodeToken = parseJwt(token);

    const messagescreen = document.getElementById('messagebox'); 
     messagescreen.innerHTML = '';
    message.forEach(chat => {     
      if(chat.userId == decodeToken.userId){    
    const divItem=document.createElement('div')
      divItem.style.border='1px solid black'
      divItem.style.width='40%'
      divItem.style.padding='10px 10px'
      divItem.style.margin='12px 5px'
      divItem.style.borderRadius='0px 12px 10px 10px'
      divItem.style.backgroundColor='#fdfdfd'

      const listItem = document.createElement('li');
      listItem.style.listStyle='none'
      listItem.textContent = chat.message; 

      const time=document.createElement('p')
        time.style.margin='0px'
        time.style.padding='0px'
        time.classList='text-end'
        const createdAt = new Date(chat.createdAt); // Convert string to Date object
        const formattedTime = `${createdAt.getDate()}-${createdAt.getMonth() + 1} ${createdAt.getHours()}:${createdAt.getMinutes()}`;
        time.textContent = formattedTime;

      divItem.appendChild(listItem);
      divItem.appendChild(time)
      messagescreen.appendChild(divItem); 
      }               
   })
          
}

function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}


let max_user=5;
async function userList(){
  try{
    const token= localStorage.getItem('token');
    const decodedToken=parseJwt(token)
    const parentElement= document.getElementById('friendlist');
    const response= await axios.get('http://localhost:3000/chat/alluser');
    const data= response.data.allUserData; 
    const allUserData= data.slice(-max_user);
    localStorage.setItem("allUserdetails", JSON.stringify(allUserData));

    if(response.status === 200){
      console.log("userList data",data)
      const userimgdiv = document.getElementById('onlineuserimg');
      const useronlinename=document.getElementById('onlineusername')
      
      data.forEach(user =>{
        if(user.name !== decodedToken.name){
          const img=document.createElement('i')
            img.classList="fa-solid fa-circle-user fs-2 me-2"          
            img.style.padding='0px 0px'
            img.style.color='#206ef3'

            const divItem = document.createElement('li');              
                divItem.style.display = 'block'; 
                divItem.style.padding = '5px 10px';
                divItem.style.margin = '0px 5px';
                divItem.style.border = '1px 0px';

              divItem.appendChild(img)

              const anchorTag = document.createElement('a');
                 anchorTag.style.textDecoration='none'
                 anchorTag.style.color='black' 
                 anchorTag.style.fontWeight='bold'
                anchorTag.style.textTransform='capitalize'  
                anchorTag.href = '#' + user.name.toLowerCase(); // Set a unique URL using user name
                anchorTag.textContent = user.name;
                anchorTag.setAttribute("data-type", "user");
                // Append the anchor tag to the list item
                anchorTag.addEventListener('click', () => {
                    localStorage.setItem('selectedUserId', user.id);
                    localStorage.removeItem('selectedGroupId');
                    
                    const userchildimg = document.createElement('i');
                    const userchilddiv = document.createElement('h6');
                    const usersubchild=document.createElement('h6')
                    userchildimg.classList = 'fa-solid fa-circle-user fs-1';
                    userchildimg.style.color='#206ef3'
                    userchilddiv.style.textTransform='uppercase'
                    userchilddiv.textContent = user.name;
                    userchilddiv.classList = 'me-4';
                    usersubchild.style.textTransform='uppercase'
                    usersubchild.textContent = user.name;
                    
                    // Clear previous user information
                    userimgdiv.innerHTML = '';
                    useronlinename.innerHTML = '';
                    userdivright.innerHTML = '';
                    
                    userimgdiv.appendChild(userchildimg);
                    useronlinename.appendChild(userchilddiv);
                    userdivright.appendChild(usersubchild)
                    fetchAndDisplayChatData();
                });

                divItem.appendChild(anchorTag);         

                parentElement.appendChild(divItem);
                const lineBreak = document.createElement('br');
                parentElement.appendChild(lineBreak);
        }
      })
    }else{
      throw new Error();
    }
  }catch(err){
    console.log("error in userlist", err)
  }
}
userList();

async function modal1(event){
        event.preventDefault();
        var name=document.getElementById('proname').value
        var group=document.getElementById('groupname').value

        const obj={
            name,group
        }
        console.log(obj)

    }

     function status1(event){
        event.preventDefault();
        var name=document.getElementById('statusupdate').value       

        const obj={
            name,
        }        
        localStorage.setItem('statusUpdate',JSON.stringify(obj)) 

    }

function userProfileVisible(){
    const token=localStorage.getItem('token')
        const decodeToken=parseJwt(token)       
        console.log(decodeToken.name)
        const profilename=document.getElementById('userprofilename')
        childelement=document.createElement('h6')
        childelement.style.textTransform='Uppercase'
        childelement.textContent=decodeToken.name
        profilename.appendChild(childelement)
}

userProfileVisible()

document.addEventListener("DOMContentLoaded", function() {
    const dropdownItemList = document.getElementById("dropdownItemList");

    const items = JSON.parse(localStorage.getItem('alluserdetails'))
            console.log("items>>",items)
    items.forEach(item => {
      const listItem = document.createElement("li");
      listItem.innerHTML = `
        <a class="dropdown-item" href="#">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${item.name}" id="${item.id}" />
            <label class="form-check-label" for="${item.id}">${item.name}</label>
          </div>
        </a>
      `;
      dropdownItemList.appendChild(listItem);
    });
  });





async function createGroup(event){
        event.preventDefault();
    
        var groupname=document.getElementById('groupname').value 
        const obj={
            name,
            groupname,
            members: getCheckedMembers()
        }
        
        
        try{
        const token = localStorage.getItem('token');
        const response=await axios.post('http://localhost:3000/chat/creategroup',obj,{headers:{'Authorization':token}})
        console.log("this is create group response", response.data.createdgroupdata) 
        data=response.data.createdgroupdata
        localStorage.setItem("groupname",JSON.stringify(data))        
        }
        catch(err){
            console.log("group data error",err)
        }
    }


    function getCheckedMembers() {
  const checkedMembers = [];
  const checkboxes = document.querySelectorAll('.form-check-input[type="checkbox"]');
  
  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      const memberId = checkbox.getAttribute('id');
      checkedMembers.push(memberId);
    }
  });

  return checkedMembers;
}

function selectGroup(groupId) {
    localStorage.setItem('selectedGroupId', groupId);
    localStorage.removeItem('selectedUserId');
    socket.emit('join-group', groupId);  // Joining the group's WebSocket channel
    fetchAndDisplayChatData();
    updateChatUI();
}




async function getGroups() {
    userlist();
    const parentElement = document.getElementById('alluserlist');
    const userimgdiv = document.getElementById('onlineuserimg');
    const useronlinename = document.getElementById('onlineusername');
    const userdivright = document.getElementById('useronline');
    try {
        const token = localStorage.getItem('token');
        const response = await axios.get('http://localhost:3000/chat/getgroup', { headers: { 'Authorization': token } });
        console.log("groups data", response.data.allGroupData);
        data = response.data.allGroupData;
        const messagebox = document.getElementById('messagebox');
        const groupbox = document.getElementById('groupdetails');
        data.forEach(group => {
            const img = document.createElement('i');
            img.classList = "fa-solid fa-people-group fs-4 me-2";
            img.style.border = '1px solid #00a884';
            img.style.borderRadius = '50%';
            img.style.color = '#00a884';
            const divItem = document.createElement('li');
            divItem.style.display = 'block';
            divItem.style.padding = '5px 10px';
            divItem.style.margin = '0px 5px';
            divItem.style.border = '1px 0px';
            divItem.style.color = "black";
            divItem.classList.add('group-item');

            const anchorTag = document.createElement('a');
            anchorTag.style.textDecoration = 'none';
            anchorTag.style.color = 'black';
            anchorTag.style.fontWeight = 'bold';
            anchorTag.style.textTransform = 'capitalize';
            anchorTag.classList.add('group-item');
            anchorTag.href = '#' + group.groupname.toLowerCase();
            anchorTag.textContent = group.groupname;
            anchorTag.setAttribute("data-type", "group");

            anchorTag.addEventListener('click',  () => {
                selectGroup(group.id);
                // userimgdiv.appendChild(img)
                // useronlinename.appendChild(divItem)
                localStorage.setItem('selectedGroupId', group.id);
                localStorage.removeItem('selectedUserId');
                // Clear chat UI
                const messagescreen = document.getElementById('messagebox');
                messagescreen.innerHTML = '';
                // Fetch and display chat data
                fetchAndDisplayChatData();
                // Update chat UI with the latest messages
                updateChatUI();
            });

            divItem.appendChild(img);
            divItem.appendChild(anchorTag);
            parentElement.appendChild(divItem);
            const lineBreak = document.createElement('br');
            parentElement.appendChild(lineBreak);
        });
    } catch (err) {
        console.log("group data error", err);
    }
}

getGroups();



updatestatus()    
function updatestatus(){
    const savedStatus = JSON.parse(localStorage.getItem('statusUpdate'));
    const status = document.getElementById('profilestatusupdate');
    status.textContent = savedStatus.name;
}

function logout() {
        socket.disconnect();
    
    localStorage.removeItem('selectedGroupId');
    localStorage.removeItem('selectedUserId');
    localStorage.removeItem('token');
}
document.getElementById('logoutButton').addEventListener('click', logout);

  </script>
    
</body>
</html>